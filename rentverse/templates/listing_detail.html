{% extends "base.html" %}

{% block title %}{{ listing.title }} - RentAssured{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('listings') }}">Listings</a></li>
            <li class="breadcrumb-item active">{{ listing.title }}</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Listing Images -->
            <div class="card mb-4">
                <div class="position-relative">
                    <img src="{{ listing.images|get_first_image }}" 
                         class="card-img-top" 
                         style="height: 400px; object-fit: cover;" 
                         alt="{{ listing.title }}">
                    <button class="like-btn" onclick="toggleLike({{ listing.id }})">
                        <i class="far fa-heart"></i>
                    </button>
                </div>
            </div>

            <!-- Listing Details -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h1 class="h3 mb-2">{{ listing.title }}</h1>
                            <p class="listing-location mb-2">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ listing.location }}
                            </p>
                            <span class="badge bg-primary">{{ listing.category.name }}</span>
                        </div>
                        <div class="text-end">
                            <div class="h4 text-primary mb-1">₹{{ listing.price }}/Day</div>
                            <div class="rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                                <span class="ms-1 text-muted">(4.0) 12 reviews</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <h5 class="mb-3">Description</h5>
                    <p class="text-muted">{{ listing.description }}</p>

                    <h5 class="mb-3">Availability</h5>
                    <p class="text-muted">{{ listing.availability|title }}</p>
                </div>
            </div>

            <!-- Lender Information -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="mb-3">Lender's Information</h5>
                    <div class="d-flex align-items-center">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 50px; height: 50px;">
                            <i class="fas fa-user text-muted"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">{{ owner.name }}</h6>
                            <p class="text-muted mb-0">Click here to view their profile</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="card">
                <div class="card-body">
                    <h5 class="mb-3">Ratings and Reviews</h5>
                    <div class="row">
                        <div class="col-md-4 text-center mb-3">
                            <div class="h2 text-primary mb-1">4.0</div>
                            <div class="rating mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="far fa-star"></i>
                            </div>
                            <p class="text-muted">Based on 12 reviews</p>
                        </div>
                        <div class="col-md-8">
                            <div class="mb-2">
                                <span class="me-2">5</span>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 60%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="me-2">4</span>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 30%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="me-2">3</span>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 10%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="me-2">2</span>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <span class="me-2">1</span>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-body">
                    <h5 class="mb-3">Book This Item</h5>
                    
                    <!-- User's existing bookings for this listing -->
                    <div id="userBookings" class="mb-4" style="display: none;">
                        <h6 class="text-primary">Your Bookings</h6>
                        <div id="bookingsList"></div>
                    </div>
                    
                    <form id="bookingForm">
                        <div class="mb-3">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="guests" class="form-label">Number of Guests</label>
                            <input type="number" class="form-control" id="guests" name="guests" value="1" min="1">
                        </div>
                        
                        <div class="border-top pt-3 mb-3">
                            <div class="d-flex justify-content-between">
                                <span>₹{{ listing.price }} × 1 day</span>
                                <span>₹{{ listing.price }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Service fee</span>
                                <span>₹{{ (listing.price|float * 0.1)|round|int }}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fw-bold">
                                <span>Total</span>
                                <span id="total_amount">₹{{ (listing.price|float * 1.1)|round|int }}</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100 btn-lg mb-3">
                            Request to Book
                        </button>
                        
                        <div class="text-center">
                            <small class="text-muted">You won't be charged until the owner confirms</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Ads Section -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="mb-4">Related Ads</h3>
            <div class="row">
                {% for i in range(4) %}
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card listing-card">
                        <div class="position-relative">
                            <img src="/static/images/placeholder.jpg" 
                                 class="card-img-top listing-image" 
                                 alt="Related listing">
                            <button class="like-btn" onclick="toggleLike({{ i + 1 }})">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">Chevrolet Tavera Car for Daily Rent</h6>
                            <p class="listing-price">₹3000/Day</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load user's bookings for this listing
async function loadUserBookings() {
    const token = localStorage.getItem('access_token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/user_bookings', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const bookings = await response.json();
            const listingId = {{ listing.id }};
            const userBookings = bookings.filter(booking => booking.listing_id === listingId);
            
            if (userBookings.length > 0) {
                displayUserBookings(userBookings);
            }
        }
    } catch (error) {
        console.error('Error loading user bookings:', error);
    }
}

function displayUserBookings(bookings) {
    const container = document.getElementById('userBookings');
    const list = document.getElementById('bookingsList');
    
    list.innerHTML = '';
    
    bookings.forEach(booking => {
        const bookingDiv = document.createElement('div');
        bookingDiv.className = 'border rounded p-3 mb-2';
        bookingDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">${new Date(booking.start_date).toLocaleDateString()} - ${new Date(booking.end_date).toLocaleDateString()}</small>
                    <div class="fw-bold">₹${booking.total_amount}</div>
                    <span class="badge bg-${booking.status === 'confirmed' ? 'success' : booking.status === 'pending' ? 'warning' : 'secondary'}">${booking.status}</span>
                </div>
                ${booking.status === 'pending' || booking.status === 'confirmed' ? 
                    `<button class="btn btn-sm btn-outline-danger" onclick="cancelBookingFromDetail(${booking.id})">
                        <i class="fas fa-times"></i>
                    </button>` : ''
                }
            </div>
        `;
        list.appendChild(bookingDiv);
    });
    
    container.style.display = 'block';
}

// Cancel booking from listing detail page
async function cancelBookingFromDetail(bookingId) {
    const reason = prompt('Please provide a reason for cancellation:');
    if (!reason) return;
    
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/cancel_booking/${bookingId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ reason: reason })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            alert(`Booking cancelled successfully!\nRefund Amount: ₹${result.refund_amount}\nPenalty: ₹${result.penalty_amount}`);
            loadUserBookings(); // Reload bookings
        } else {
            alert(`Error: ${result.error}`);
        }
    } catch (error) {
        console.error('Error cancelling booking:', error);
        alert('An error occurred while cancelling the booking.');
    }
}

// Load user bookings when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadUserBookings();
});

document.getElementById('bookingForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Frontend validation
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(document.getElementById('end_date').value);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Clear previous error messages
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    
    let hasErrors = false;
    
    // Validate dates
    if (!document.getElementById('start_date').value) {
        showBookingError('start_date', 'Please select a start date');
        hasErrors = true;
    } else if (startDate < today) {
        showBookingError('start_date', 'Start date cannot be in the past');
        hasErrors = true;
    }
    
    if (!document.getElementById('end_date').value) {
        showBookingError('end_date', 'Please select an end date');
        hasErrors = true;
    } else if (endDate <= startDate) {
        showBookingError('end_date', 'End date must be after start date');
        hasErrors = true;
    }
    
    // Check if booking is not too far in the future (max 1 year)
    const maxFutureDate = new Date();
    maxFutureDate.setFullYear(maxFutureDate.getFullYear() + 1);
    if (startDate > maxFutureDate) {
        showBookingError('start_date', 'Booking cannot be more than 1 year in advance');
        hasErrors = true;
    }
    
    if (hasErrors) {
        return;
    }
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // Check if user is logged in
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert('Please login to make a booking');
        window.location.href = '/login';
        return;
    }
    
    // Calculate total amount
    const price = {{ listing.price }};
    const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
    const totalAmount = price * days * 1.1; // 10% service fee
    
    data.listing_id = {{ listing.id }};
    data.total_amount = totalAmount;
    
    try {
        console.log('Sending booking request with token:', token.substring(0, 20) + '...');
        console.log('Booking data:', data);
        
        const response = await fetch('/book_listing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Response data:', result);
        
        if (response.ok) {
            alert('Booking request sent successfully!');
            window.location.href = '/dashboard?token=' + token;
        } else {
            alert(result.error || 'Booking failed');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }
});

// Update total amount when dates change
function updateTotal() {
    const startDate = new Date(document.getElementById('start_date').value);
    const endDate = new Date(document.getElementById('end_date').value);
    const price = {{ listing.price }};
    
    if (startDate && endDate && endDate >= startDate) {
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        const totalAmount = price * days * 1.1;
        document.getElementById('total_amount').textContent = '₹' + Math.round(totalAmount);
    }
}

document.getElementById('start_date').addEventListener('change', updateTotal);
document.getElementById('end_date').addEventListener('change', updateTotal);

// Set minimum date to today
const today = new Date().toISOString().split('T')[0];
document.getElementById('start_date').setAttribute('min', today);
document.getElementById('end_date').setAttribute('min', today);

// Function to show error messages for booking form
function showBookingError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message text-danger small mt-1';
    errorDiv.textContent = message;
    field.parentNode.appendChild(errorDiv);
    field.classList.add('is-invalid');
}

function toggleLike(listingId) {
    const token = localStorage.getItem('access_token');
    if (!token) {
        alert('Please login to like listings');
        return;
    }
    
    const likeBtn = event.target.closest('.like-btn');
    const icon = likeBtn.querySelector('i');
    
    if (icon.classList.contains('far')) {
        icon.classList.remove('far');
        icon.classList.add('fas');
        likeBtn.classList.add('liked');
    } else {
        icon.classList.remove('fas');
        icon.classList.add('far');
        likeBtn.classList.remove('liked');
    }
}
</script>
{% endblock %}